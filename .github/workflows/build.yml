name: Build Slipstream Server ARM64

on:
  workflow_dispatch:

jobs:
  build-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build inside Docker
        run: |
          docker run --rm -v ${{ github.workspace }}:/project -w /project \
            rust:slim-bookworm \
            bash -c "
              set -e
              
              echo '>>> Preparing System...'
              dpkg --add-architecture arm64
              apt-get update
              apt-get install -y git cmake make perl pkg-config \
                gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
                libssl-dev:arm64 libbrotli-dev:arm64
              
              git config --global --add safe.directory /project
              rustup target add aarch64-unknown-linux-gnu
              
              # تنظیم متغیرهای محیطی با آدرس‌های مطلق (Absolute Paths)
              # این کار باعث می‌شود اسکریپت بیلد Rust گیج نشود
              export PICOQUIC_DIR=/project/.picoquic-build
              export PICOQUIC_BUILD_DIR=/project/.picoquic-build
              export PICOQUIC_LIB_DIR=/project/.picoquic-build
              export PICOQUIC_INCLUDE_DIR=/project/vendor/picoquic/picoquic
              
              # تنظیمات OpenSSL برای ARM64
              export OPENSSL_DIR=/usr/lib/aarch64-linux-gnu
              export OPENSSL_LIB_DIR=/usr/lib/aarch64-linux-gnu
              export OPENSSL_INCLUDE_DIR=/usr/include/aarch64-linux-gnu
              export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
              
              # تنظیمات کراس‌کامپایلر
              export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
              export CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
              export CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++
              
              # نکته مهم: اگر بیلد قبلی ناقص بوده، پوشه بیلد را پاک می‌کنیم تا از اول تمیز ساخته شود
              # اما چون در داکر هستیم، معمولاً پوشه موقت پاک می‌شود.
              
              echo '>>> Starting Cargo Build...'
              cargo build --release --target aarch64-unknown-linux-gnu -p slipstream-server
            "

      - name: Upload Server Binary
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-server-arm64
          path: target/aarch64-unknown-linux-gnu/release/slipstream-server
