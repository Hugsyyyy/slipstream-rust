name: ARM64 Manual Build

on:
  workflow_dispatch:

jobs:
  build-aarch64:
    name: Build Release for ARM64
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          # ما اینجا فقط به لینکر و ابزارهای پایه نیاز داریم
          sudo apt-get install -y gcc-aarch64-linux-gnu cmake pkg-config python3 perl make

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Build Binary
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
          # این خط کلیدی است: OpenSSL را خودش برای ARM میسازد
          OPENSSL_VENDORED: 1
          # اگر پروژه از لایبری‌های سیستم استفاده میکند، این کمک میکند
          PKG_CONFIG_ALLOW_CROSS: 1
        run: cargo build --release --target aarch64-unknown-linux-gnu

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: slipstream-aarch64-binary
          path: target/aarch64-unknown-linux-gnu/release/slipstream
